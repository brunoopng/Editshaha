<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Project ‚Äî Supabase Public Feed</title>
<style>
:root{ --bg:#050505; --accent:#ffd400; --card-duration:420ms; --stagger:80ms; --radius:12px; font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial; }
*{box-sizing:border-box} html,body{height:100%;margin:0;background:var(--bg);color:#fff;overflow:hidden}
.header{height:64px;display:flex;align-items:center;justify-content:space-between;padding:12px 20px;border-bottom:1px solid rgba(255,255,255,0.02)}
.brand{display:flex;align-items:center;gap:12px}.logo{display:flex;align-items:center;gap:10px;font-weight:800;color:var(--accent);letter-spacing:0.6px;font-size:18px}.logo-mark{width:38px;height:38px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#ffcc00);display:inline-flex;align-items:center;justify-content:center;color:#000;font-weight:900}
.header-actions{display:flex;align-items:center;gap:10px}.user-badge{display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);color:var(--accent);font-weight:700}
.btn-upload{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:10px;color:var(--accent);cursor:pointer;font-weight:700;display:inline-flex;align-items:center;gap:8px}
.viewport{height:calc(100vh - 64px);display:flex;overflow-x:auto;overflow-y:hidden;scroll-snap-type:x mandatory;scroll-behavior:smooth;-webkit-overflow-scrolling:touch;background:linear-gradient(180deg, rgba(0,0,0,0.02), transparent)}
.card{flex:0 0 100vw;height:calc(100vh - 64px);position:relative;display:flex;align-items:center;justify-content:center;scroll-snap-align:center;transition:transform .20s ease,opacity .32s ease;opacity:0;transform:translateY(6px);background:#000}
.card.enter{ animation: cardIn var(--card-duration) cubic-bezier(.2,.9,.28,1) both }
@keyframes cardIn{ from{ opacity:0; transform:translateY(12px) scale(.998) } to{ opacity:1; transform:translateY(0) scale(1) } }
.media{position:relative;width:100%;height:100%;overflow:hidden}.media video{width:100%;height:100%;object-fit:cover;display:block;background:#000;transition:opacity .45s cubic-bezier(.2,.9,.28,1),transform .45s;opacity:0;transform:scale(1.02) translateY(6px)}
.card.active{transform:scale(1.01)}.card.active::after{content:"";position:absolute;inset:0;box-shadow:inset 0 0 0 2px rgba(255,212,0,0.06);pointer-events:none}.card.active video{ opacity:1; transform:scale(1) translateY(0) }.card:not(.active) video{ opacity:0 }
.sound-toggle{position:absolute;left:12px;top:12px;z-index:40;background:transparent;border:1px solid rgba(255,255,255,0.04);width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--accent)}
.top-actions{position:absolute;right:12px;top:12px;display:flex;flex-direction:row;gap:8px;z-index:40;opacity:0;transform:translateY(-6px);transition:opacity .36s ease, transform .36s ease}
.card.enter .top-actions{ animation: slideFade .42s ease both } @keyframes slideFade{ from{opacity:0; transform:translateY(-8px)} to{opacity:1; transform:none} }
.icon-btn{width:44px;height:44px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;display:flex;align-items:center;justify-content:center;color:var(--accent);cursor:pointer}
.reaction-bar{position:absolute;right:58px;top:50%;transform:translateY(-50%);display:flex;flex-direction:column;gap:12px;align-items:center;z-index:40;opacity:0;transform-origin:center right;transition:opacity .36s ease, transform .36s ease}
.card.enter .reaction-bar{ animation: slideInRight .42s ease both } @keyframes slideInRight{ from{opacity:0; transform:translateY(-50%) translateX(12px)} to{opacity:1; transform:translateY(-50%) translateX(0)} }
.reaction{width:58px;height:58px;border-radius:12px;background:rgba(0,0,0,0.42);display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,0.03);cursor:pointer;transition:transform .12s,box-shadow .12s,background .18s;color:var(--accent)}.reaction:active{transform:translateY(-3px)}.reaction svg{width:22px;height:22px;fill:currentColor}.reaction.pop{ animation: pop .32s cubic-bezier(.2,.9,.28,1) both } @keyframes pop{ 0%{ transform:translateY(0) scale(1) } 40%{ transform:translateY(-6px) scale(1.08) } 100%{ transform:translateY(0) scale(1) } }
.meta{position:absolute;left:16px;bottom:16px;padding:8px 12px;border-radius:10px;background:linear-gradient(90deg, rgba(0,0,0,0.36), transparent);border:1px solid rgba(255,255,255,0.03);z-index:35;opacity:0;transform:translateY(6px);transition:opacity .36s ease, transform .36s ease}
.card.enter .meta{ animation: metaIn .42s ease both } @keyframes metaIn{ from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:none} }
.meta .title{font-weight:800} .meta .sub{font-size:13px;color:rgba(255,255,255,0.78)}
.dots{position:absolute;top:14px;left:50%;transform:translateX(-50%);display:flex;gap:6px;z-index:45}.dot{width:8px;height:8px;border-radius:999px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.02);transition:transform .24s ease, background .24s ease, box-shadow .24s ease}.dot.active{background:var(--accent);box-shadow:0 6px 18px rgba(255,212,0,0.06);transform:scale(1.28)}
.dialog{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:100;visibility:hidden;opacity:0;transition:opacity .18s}.dialog.open{visibility:visible;opacity:1}
.dialog-panel{width:480px;background:#0b0b0b;border-radius:12px;padding:16px;border:1px solid rgba(255,255,255,0.04);transform:translateY(8px);opacity:0;transition:opacity .28s ease, transform .28s ease; will-change:transform,opacity}
.dialog.open .dialog-panel{ transform:translateY(0); opacity:1 }
.field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}.input{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px;border-radius:8px;color:#fff}
.login-panel{width:360px;padding:18px}@media (max-width:900px){ .icon-btn{width:40px;height:40px} .sound-toggle{left:10px;top:10px;width:40px;height:40px} .reaction-bar{right:18px} .reaction{width:52px;height:52px} .meta{left:12px;bottom:12px;padding:8px} }
</style>
</head>
<body>

<header class="header" role="banner">
  <div class="brand"><div class="logo-mark">P</div><div class="logo">Project</div></div>
  <div class="header-actions">
    <div id="userArea" class="user-badge" style="display:none"><span id="userName"></span><button id="logoutBtn" title="Sair" style="background:transparent;border:none;color:var(--accent);cursor:pointer">‚éã</button></div>
    <button class="btn-upload" id="btnUpload" title="Upload">Enviar</button>
  </div>
</header>

<main id="viewport" class="viewport" role="main" aria-label="Feed"></main>
<div class="dots" id="dots"></div>

<!-- upload dialog -->
<div id="dialog" class="dialog" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="dialog-panel" role="document">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><strong>Novo v√≠deo</strong><button id="closeDialog" style="background:transparent;border:none;color:var(--accent);cursor:pointer">‚úï</button></div>
    <div class="field"><label>Arquivo</label><input id="fileInput" type="file" accept="video/*" class="input" /></div>
    <div class="field"><label>T√≠tulo</label><input id="titleInput" class="input" placeholder="T√≠tulo" /></div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button id="cancelUpload" style="background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:8px;color:var(--accent);cursor:pointer">Cancelar</button>
      <button id="confirmUpload" style="background:var(--accent);color:#000;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700">Enviar</button>
    </div>
    <div id="uploadStatus" style="margin-top:10px;font-size:13px;color:rgba(255,255,255,0.7)"></div>
  </div>
</div>

<!-- login dialog -->
<div id="login" class="dialog" aria-hidden="true">
  <div class="dialog-panel login-panel" role="document">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><strong>Entrar</strong></div>
    <div class="field"><label>Seu nome (apenas identifica√ß√£o)</label><input id="loginName" class="input" placeholder="Seu nome" /></div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button id="loginCancel" style="background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:8px;color:var(--accent);cursor:pointer">Cancelar</button>
      <button id="loginConfirm" style="background:var(--accent);color:#000;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700">Entrar</button>
    </div>
  </div>
</div>

<!-- Supabase JS (ESM) -->
<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  // ====== SUBSTITUA AQUI ======
  const SUPABASE_URL = 'https://nfvygrfdzpmlbpflvttv.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5mdnlncmZkenBtbGJwZmx2dHR2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMDQ2OTYsImV4cCI6MjA4NTg4MDY5Nn0.Ksg71P2nwpr71bTgscJiytuBCD_0sclaFSErLCyVPXk';
  // ============================

  if(!SUPABASE_URL || !SUPABASE_ANON_KEY){
    alert('Cole SUPABASE_URL e SUPABASE_ANON_KEY no arquivo index.html antes de publicar.');
  }

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { realtime: { params: { eventsPerSecond: 10 } }});

  /* UI refs */
  const viewport = document.getElementById('viewport');
  const dotsEl = document.getElementById('dots');
  const dialog = document.getElementById('dialog');
  const btnUpload = document.getElementById('btnUpload');
  const closeDialog = document.getElementById('closeDialog');
  const fileInput = document.getElementById('fileInput');
  const titleInput = document.getElementById('titleInput');
  const confirmUpload = document.getElementById('confirmUpload');
  const cancelUpload = document.getElementById('cancelUpload');
  const uploadStatus = document.getElementById('uploadStatus');
  const loginModal = document.getElementById('login');
  const loginName = document.getElementById('loginName');
  const loginConfirm = document.getElementById('loginConfirm');
  const loginCancel = document.getElementById('loginCancel');
  const userArea = document.getElementById('userArea');
  const userNameEl = document.getElementById('userName');
  const logoutBtn = document.getElementById('logoutBtn');

  let viewer = { id: null, name: null };

  // simple client-side id generator
  function makeId(prefix='u'){ return prefix + Math.random().toString(36).slice(2,9); }

  /* --- login handling (name-only, no Supabase Auth required) --- */
  function showLogin(show = true){
    loginModal.classList.toggle('open', show);
    loginModal.style.visibility = show ? 'visible' : 'hidden';
    loginModal.setAttribute('aria-hidden', show ? 'false' : 'true');
    if(show) loginName.focus();
  }

  function setViewer(name){
    viewer.name = name;
    viewer.id = localStorage.getItem('viewer_id') || makeId('v');
    localStorage.setItem('viewer_name', name);
    localStorage.setItem('viewer_id', viewer.id);
    userArea.style.display = 'flex';
    userNameEl.textContent = name;
  }

  function clearViewer(){
    viewer = { id: null, name: null };
    localStorage.removeItem('viewer_name');
    localStorage.removeItem('viewer_id');
    userArea.style.display = 'none';
    userNameEl.textContent = '';
    showLogin(true);
  }

  (function initViewer(){
    const name = localStorage.getItem('viewer_name');
    const id = localStorage.getItem('viewer_id');
    if(name && id){ viewer = { id, name }; userArea.style.display = 'flex'; userNameEl.textContent = name; showLogin(false); }
    else showLogin(true);
  })();

  loginConfirm.addEventListener('click', ()=>{
    const v = loginName.value.trim();
    if(!v) return alert('Digite um nome curto para entrar.');
    setViewer(v);
    showLogin(false);
  });
  loginCancel.addEventListener('click', ()=> showLogin(false));
  logoutBtn.addEventListener('click', ()=> clearViewer());

  /* ---------- feed rendering ---------- */
  function buildFeedFrom(items){
    viewport.innerHTML = '';
    dotsEl.innerHTML = '';
    items.forEach((it, idx) => {
      const card = document.createElement('section');
      card.className = 'card enter';
      card.dataset.index = idx;
      card.style.animationDelay = (idx * parseInt(getComputedStyle(document.documentElement).getPropertyValue('--stagger')||80)) + 'ms';

      const media = document.createElement('div'); media.className = 'media';
      const video = document.createElement('video'); video.muted = true; video.playsInline = true; video.loop = true; video.preload = 'metadata';
      const src = document.createElement('source'); src.src = it.url; src.type = it.type || 'video/mp4'; video.appendChild(src);
      video.style.objectFit = it.aspect || 'cover';

      const badge = document.createElement('div'); badge.className='feature-badge'; badge.style.position='absolute'; badge.style.top='16px'; badge.style.left='50%'; badge.style.transform='translateX(-50%)'; badge.style.opacity=0; badge.style.transition='opacity .42s ease';
      badge.innerHTML = `<div style="font-weight:800;color:var(--accent)">${it.title || '‚Äî'}</div>`;
      setTimeout(()=> badge.style.opacity = '1', idx * 80 + 160);

      const soundBtn = document.createElement('button'); soundBtn.className='sound-toggle'; soundBtn.title='Play / sound';
      soundBtn.innerHTML = `<svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M5 9v6h4l5 5V4L9 9H5z"/></svg>`;
      soundBtn.addEventListener('click', (ev)=>{ ev.stopPropagation(); if(video.paused){ video.muted=false; video.volume=0.9; video.play().catch(()=>{}); } else { video.muted = !video.muted; } });

      const topActions = document.createElement('div'); topActions.className='top-actions';
      topActions.innerHTML = `
        <button class="icon-btn" title="Share" data-id="${it.id}">üîó</button>
        <button class="icon-btn" title="Download" data-id="${it.id}">‚¨áÔ∏è</button>
        <button class="icon-btn aspect-btn" title="Propor√ß√£o" data-mode="${it.aspect || 'cover'}">‚ñ≠</button>
      `;

      const reaction = document.createElement('div'); reaction.className='reaction-bar';
      reaction.innerHTML = `<button class="reaction" title="Like">‚ù§</button><button class="reaction" title="Comment">üí¨</button><button class="reaction" title="Save">üîñ</button>`;

      const meta = document.createElement('div'); meta.className='meta';
      const created = it.created ? new Date(it.created).toLocaleString() : '';
      meta.innerHTML = `<div class="title">${it.title || 'Sem t√≠tulo'}</div><div class="sub">${it.uploader || 'An√¥nimo'} ‚Ä¢ ${created}</div>`;

      media.addEventListener('click', (e)=>{ const tag = e.target.tagName.toLowerCase(); if(tag === 'button' || e.target.closest('button')) return; if(video.paused){ video.muted=false; video.volume=0.9; video.play().catch(()=>{}); } else { video.pause(); } });

      reaction.querySelectorAll('.reaction').forEach(btn=> btn.addEventListener('click', (ev)=>{ ev.stopPropagation(); btn.classList.remove('pop'); void btn.offsetWidth; btn.classList.add('pop'); setTimeout(()=> btn.classList.remove('pop'),420); }));

      topActions.querySelectorAll('.icon-btn').forEach(b=> b.addEventListener('click', (ev)=>{ ev.stopPropagation(); if(b.title === 'Share'){ if(navigator.share) navigator.share({ title: it.title, url: it.url }).catch(()=>{}); else prompt('Link:', it.url); } else if(b.title === 'Download'){ const a=document.createElement('a'); a.href = it.url; a.download = (it.title||'video')+'.mp4'; document.body.appendChild(a); a.click(); a.remove(); } }));

      const aspectBtn = topActions.querySelector('.aspect-btn');
      if(aspectBtn) aspectBtn.addEventListener('click', (ev)=>{ ev.stopPropagation(); const current = aspectBtn.dataset.mode || 'cover'; const next = current === 'cover' ? 'contain' : 'cover'; aspectBtn.dataset.mode = next; video.style.objectFit = next; });

      media.appendChild(video); media.appendChild(badge); media.appendChild(soundBtn); media.appendChild(topActions); media.appendChild(reaction); media.appendChild(meta);
      card.appendChild(media); viewport.appendChild(card);

      const dot = document.createElement('div'); dot.className='dot'; dot.dataset.index=idx; dot.addEventListener('click', ()=> scrollToIndex(idx)); dot.style.transitionDelay = (idx * 30) + 'ms'; dotsEl.appendChild(dot);
    });

    requestAnimationFrame(()=> setTimeout(()=> updateActiveCard(), 60));
  }

  /* active card handling */
  const vp = viewport;
  function updateActiveCard(){
    const cards = Array.from(document.querySelectorAll('.card'));
    if(cards.length === 0) return;
    const vCenter = vp.scrollLeft + vp.clientWidth/2;
    let closest = null, min = Infinity;
    cards.forEach(c=>{ const cCenter = c.offsetLeft + c.clientWidth/2; const dist = Math.abs(cCenter - vCenter); if(dist < min){ min = dist; closest = c; min = dist; }});
    cards.forEach(c=>{ const v = c.querySelector('video'); if(c === closest){ c.classList.add('active'); setTimeout(()=>{ if(v) v.play().catch(()=>{}); }, 80); } else { c.classList.remove('active'); if(v){ try{ v.pause(); v.currentTime = 0; v.muted = true; }catch(e){} } }});
    const idx = parseInt(closest.dataset.index || 0, 10);
    Array.from(dotsEl.children).forEach((d,i)=> d.classList.toggle('active', i === idx));
  }
  function scrollToIndex(i){ const t = vp.children[i]; if(t) vp.scrollTo({ left: t.offsetLeft, behavior: 'smooth' }); }

  vp.addEventListener('wheel', (e)=>{ if(Math.abs(e.deltaX) > Math.abs(e.deltaY)) return; e.preventDefault(); vp.scrollLeft += e.deltaY * 1.6; }, { passive: false });
  let st; vp.addEventListener('scroll', ()=>{ if(st) clearTimeout(st); st = setTimeout(()=> updateActiveCard(), 80); });
  document.addEventListener('keydown', (e)=>{ if(e.key === 'ArrowRight') scrollToIndex(Math.min(document.querySelectorAll('.card').length-1, getCurrentIndex()+1)); if(e.key === 'ArrowLeft') scrollToIndex(Math.max(0, getCurrentIndex()-1)); });
  function getCurrentIndex(){ const vCenter = vp.scrollLeft + vp.clientWidth/2; let idx=0,min=Infinity; Array.from(vp.children).forEach((c,i)=>{ const cc = c.offsetLeft + c.clientWidth/2; const dist = Math.abs(cc - vCenter); if(dist < min){ min = dist; idx = i; } }); return idx; }

  /* --------- Upload flow (Supabase Storage + table) ---------- */
  btnUpload.addEventListener('click', ()=>{
    if(!viewer || !viewer.name){ showLogin(true); return; }
    dialog.classList.add('open'); dialog.style.visibility='visible'; dialog.setAttribute('aria-hidden','false');
  });
  closeDialog.addEventListener('click', closeDlg);
  cancelUpload.addEventListener('click', closeDlg);
  function closeDlg(){ dialog.classList.remove('open'); dialog.style.visibility='hidden'; dialog.setAttribute('aria-hidden','true'); fileInput.value=''; titleInput.value=''; uploadStatus.textContent=''; }

  confirmUpload.addEventListener('click', async ()=>{
    if(!viewer || !viewer.name) return alert('Fa√ßa login com um nome antes de enviar.');
    const f = fileInput.files[0]; if(!f) return alert('Selecione um arquivo de v√≠deo.'); if(!f.type.startsWith('video/')) return alert('Apenas arquivos de v√≠deo s√£o permitidos.');
    const title = (titleInput.value.trim() || f.name);
    uploadStatus.textContent = 'Enviando...';
    confirmUpload.disabled = true;
    try {
      // build safe filename and path
      const safeName = f.name.replace(/\s+/g,'_').replace(/[^a-zA-Z0-9_\-\.]/g,'');
      const path = `${viewer.id}_${Date.now()}_${safeName}`;
      // upload to bucket 'videos'
      const { data: uploadData, error: uploadErr } = await supabase.storage.from('videos').upload(path, f);
      if(uploadErr){
        console.error('upload error', uploadErr);
        uploadStatus.textContent = 'Erro ao enviar';
        confirmUpload.disabled = false;
        return;
      }
      // get public URL
      const { data: publicData } = supabase.storage.from('videos').getPublicUrl(uploadData.path);
      const publicUrl = publicData?.publicUrl || (`/storage/v1/object/public/videos/${uploadData.path}`);
      // insert metadata into table 'videos'
      const { error: insertErr } = await supabase.from('videos').insert([{
        title,
        url: publicUrl,
        uploader: viewer.name,
        uploader_id: viewer.id,
        created: Date.now(),
        type: f.type,
        aspect: 'cover'
      }]);
      if(insertErr){
        console.error('insert error', insertErr);
        uploadStatus.textContent = 'Erro ao salvar metadados';
      } else {
        uploadStatus.textContent = 'Enviado com sucesso!';
        fileInput.value = ''; titleInput.value = '';
        closeDlg();
      }
    } catch(e){
      console.error(e);
      uploadStatus.textContent = 'Falha no upload';
    } finally {
      confirmUpload.disabled = false;
    }
  });

  /* ---------- realtime & initial load ---------- */
  async function fetchInitial(){
    const { data, error } = await supabase.from('videos').select('*').order('created', { ascending: false });
    if(error){ console.error('fetch error', error); return; }
    buildFeedFrom(data || []);
  }

  // realtime subscription to INSERTs on table 'videos'
  const channel = supabase.channel('public:videos')
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'videos' }, payload => {
      // prepend new item to feed
      try {
        const newItem = payload.new;
        // fetch current items -> prepend -> rebuild (simple approach)
        const cards = Array.from(document.querySelectorAll('.card'));
        // reconstruct quickly: fetch initial again (simple and safe)
        fetchInitial();
      } catch(e){ console.error('realtime handler error', e); }
    })
    .subscribe( (status) => {
      // console.log('realtime status', status);
    });

  // start
  fetchInitial();

</script>
</body>
</html>